{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "definitions": {
    "StageStatus": {
      "type": "string",
      "enum": ["pending", "ready", "running", "blocked", "done", "failed"]
    }
  },
  "schemas": {
    "schema.UserSession": {
      "$id": "schema.UserSession",
      "type": "object",
      "required": ["userId", "role"],
      "properties": {
        "userId": { "type": "string", "minLength": 1 },
        "role": { "type": "string", "enum": ["operator", "observer"] },
        "permissions": { "type": "array", "items": { "type": "string" } }
      }
    },
    "schema.ConsoleState": {
      "$id": "schema.ConsoleState",
      "type": "object",
      "required": ["activeRunContext", "panes"],
      "properties": {
        "activeRunContext": { "$ref": "schema.RunSelector" },
        "panes": { "type": "array", "items": { "type": "string" } }
      }
    },
    "schema.RunSelector": {
      "$id": "schema.RunSelector",
      "type": "object",
      "required": ["runId"],
      "properties": {
        "runId": { "type": "string", "minLength": 1 },
        "mode": { "type": "string", "enum": ["live", "replay"] }
      }
    },
    "schema.WorkflowSnapshot": {
      "$id": "schema.WorkflowSnapshot",
      "type": "object",
      "required": ["runId", "generatedAt", "stages"],
      "properties": {
        "runId": { "type": "string" },
        "generatedAt": { "type": "string", "format": "date-time" },
        "dependencyHash": { "type": "string" },
        "stages": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["stageId", "name", "status", "dependencies"],
            "properties": {
              "stageId": { "type": "string" },
              "name": { "type": "string" },
              "status": { "$ref": "#/definitions/StageStatus" },
              "dependencies": {
                "type": "array",
                "items": { "type": "string" }
              },
              "artifacts": {
                "type": "array",
                "items": { "$ref": "schema.ArtifactRef" }
              },
              "owner": { "type": "string" },
              "eta": { "type": "string", "format": "date-time" }
            }
          }
        }
      }
    },
    "schema.RenderResult": {
      "$id": "schema.RenderResult",
      "type": "object",
      "required": ["sections"],
      "properties": {
        "sections": { "type": "integer", "minimum": 1 },
        "warnings": { "type": "array", "items": { "type": "string" } }
      }
    },
    "schema.ArtifactRef": {
      "$id": "schema.ArtifactRef",
      "type": "object",
      "required": ["artifactId", "stageId"],
      "properties": {
        "artifactId": { "type": "string" },
        "stageId": { "type": "string" }
      }
    },
    "schema.ArtifactView": {
      "$id": "schema.ArtifactView",
      "type": "object",
      "required": ["ref", "metadata"],
      "properties": {
        "ref": { "$ref": "schema.ArtifactRef" },
        "metadata": {
          "type": "object",
          "properties": {
            "createdAt": { "type": "string", "format": "date-time" },
            "author": { "type": "string" },
            "source": { "type": "string" }
          },
          "required": ["createdAt"]
        },
        "contentPreview": { "type": "string" }
      }
    },
    "schema.RunConfigTemplate": {
      "$id": "schema.RunConfigTemplate",
      "type": "object",
      "required": ["runType", "allowedVariants", "defaultBriefDepth"],
      "properties": {
        "runType": { "type": "string" },
        "allowedVariants": { "type": "integer", "minimum": 1 },
        "defaultBriefDepth": { "type": "integer", "minimum": 1 },
        "reviewerBots": {
          "type": "array",
          "items": { "type": "string" }
        },
        "followUpPolicyOptions": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "schema.RunConfigDraft": {
      "$id": "schema.RunConfigDraft",
      "type": "object",
      "required": ["runId", "operatorId", "variantsRequested", "briefDepth", "reviewerBots", "followUpPolicy"],
      "properties": {
        "runId": { "type": "string" },
        "operatorId": { "type": "string" },
        "variantsRequested": { "type": "integer", "minimum": 1 },
        "briefDepth": { "type": "integer", "minimum": 1 },
        "reviewerBots": {
          "type": "array",
          "items": { "type": "string" }
        },
        "followUpPolicy": { "type": "string" },
        "configValidated": { "type": "boolean" },
        "notes": { "type": "string" }
      }
    },
    "schema.RunConfigCommit": {
      "$id": "schema.RunConfigCommit",
      "type": "object",
      "required": ["runId", "status", "committedAt"],
      "properties": {
        "runId": { "type": "string" },
        "status": { "type": "string", "enum": ["staged", "dispatched"] },
        "committedAt": { "type": "string", "format": "date-time" }
      }
    },
    "schema.CodexDraftRequest": {
      "$id": "schema.CodexDraftRequest",
      "type": "object",
      "required": ["runId", "prompt", "context"],
      "properties": {
        "runId": { "type": "string" },
        "prompt": { "type": "string", "minLength": 1 },
        "context": { "type": "object" },
        "promptTokens": { "type": "integer", "minimum": 1 }
      }
    },
    "schema.CodexDraftResponse": {
      "$id": "schema.CodexDraftResponse",
      "type": "object",
      "required": ["draftSegments", "usageTokens"],
      "properties": {
        "draftSegments": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["role", "content"],
            "properties": {
              "role": { "type": "string" },
              "content": { "type": "string" }
            }
          }
        },
        "usageTokens": { "type": "integer", "minimum": 0 },
        "safetyFlags": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "schema.DraftDocument": {
      "$id": "schema.DraftDocument",
      "type": "object",
      "required": ["type", "content", "metadata"],
      "properties": {
        "type": { "type": "string" },
        "content": { "type": "string" },
        "metadata": {
          "type": "object",
          "properties": {
            "rcmAligned": { "type": "boolean" },
            "lastCodexRunId": { "type": "string" }
          },
          "required": ["rcmAligned"]
        }
      }
    },
    "schema.ValidationOutcome": {
      "$id": "schema.ValidationOutcome",
      "type": "object",
      "required": ["isValid", "issues"],
      "properties": {
        "isValid": { "type": "boolean" },
        "issues": {
          "type": "array",
          "items": { "$ref": "schema.ValidationIssue" }
        }
      }
    },
    "schema.ValidationIssue": {
      "$id": "schema.ValidationIssue",
      "type": "object",
      "required": ["code", "message"],
      "properties": {
        "code": { "type": "string" },
        "message": { "type": "string" }
      }
    },
    "schema.ArtifactPayload": {
      "$id": "schema.ArtifactPayload",
      "type": "object",
      "required": ["runId", "stageId", "artifact"],
      "properties": {
        "runId": { "type": "string" },
        "stageId": { "type": "string" },
        "artifact": { "$ref": "schema.ArtifactView" }
      }
    },
    "schema.Ack": {
      "$id": "schema.Ack",
      "type": "object",
      "required": ["status"],
      "properties": {
        "status": { "type": "string", "enum": ["accepted", "rejected"] },
        "reason": { "type": "string" }
      }
    },
    "schema.RunHistoryEntry": {
      "$id": "schema.RunHistoryEntry",
      "type": "object",
      "required": ["runId", "capturedAt", "snapshots"],
      "properties": {
        "runId": { "type": "string" },
        "capturedAt": { "type": "string", "format": "date-time" },
        "snapshots": {
          "type": "array",
          "items": { "$ref": "schema.WorkflowSnapshot" }
        },
        "config": { "$ref": "schema.RunConfigDraft" }
      }
    },
    "schema.PreflightReport": {
      "$id": "schema.PreflightReport",
      "type": "object",
      "required": ["status", "findings"],
      "properties": {
        "status": { "type": "string", "enum": ["pass", "warn", "fail"] },
        "findings": {
          "type": "array",
          "items": { "$ref": "schema.ValidationIssue" }
        }
      }
    },
    "schema.ArtifactExportRequest": {
      "$id": "schema.ArtifactExportRequest",
      "type": "object",
      "required": ["runId", "targetPath", "artifactIds"],
      "properties": {
        "runId": { "type": "string" },
        "targetPath": { "type": "string" },
        "artifactIds": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  }
}
