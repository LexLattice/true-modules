{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://true-modules/spec/events.schema.json",
  "title": "tm-events@1",
  "$defs": {
    "side_effect_summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["declared", "observed_operations", "undeclared_operations", "fs_write", "processes"],
      "properties": {
        "declared": { "type": "array", "items": { "type": "string" } },
        "observed_operations": { "type": "array", "items": { "type": "string" } },
        "undeclared_operations": { "type": "array", "items": { "type": "string" } },
        "fs_write": {
          "type": "object",
          "additionalProperties": false,
          "required": ["count", "outside_module_root", "sample_paths", "outside_samples"],
          "properties": {
            "count": { "type": "integer", "minimum": 0 },
            "outside_module_root": { "type": "boolean" },
            "sample_paths": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["path", "inside_module_root"],
                "properties": {
                  "path": { "type": "string" },
                  "inside_module_root": { "type": "boolean" }
                }
              }
            },
            "outside_samples": { "type": "array", "items": { "type": "string" } }
          }
        },
        "processes": {
          "type": "object",
          "additionalProperties": false,
          "required": ["total", "categories"],
          "properties": {
            "total": { "type": "integer", "minimum": 0 },
            "categories": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "additionalProperties": false,
                "required": ["count", "sample_commands"],
                "properties": {
                  "count": { "type": "integer", "minimum": 0 },
                  "sample_commands": { "type": "array", "items": { "type": "string" } }
                }
              }
            }
          }
        }
      }
    }
  },
  "type": "object",
  "additionalProperties": false,
  "required": ["schema", "event", "ts", "seq", "source", "context"],
  "properties": {
    "schema": { "const": "tm-events@1" },
    "event": {
      "type": "string",
      "enum": [
        "GATES_START",
        "COMPOSE_OVERRIDES_APPLIED",
        "GATES_PASS",
        "GATES_FAIL",
        "GATES_WARN",
        "TEST_START",
        "TEST_PASS",
        "TEST_FAIL",
        "LINT_START",
        "LINT_PASS",
        "LINT_FAIL",
        "TSC_START",
        "TSC_PASS",
        "TSC_FAIL",
        "PORT_CHECK_START",
        "PORT_CHECK_PASS",
        "PORT_CHECK_FAIL",
        "META_PICK",
        "SIDEEFFECTS_SUMMARY",
        "ORACLE_START",
        "ORACLE_PASS",
        "ORACLE_FAIL"
      ]
    },
    "ts": { "type": "string", "format": "date-time" },
    "seq": { "type": "integer", "minimum": 1 },
    "source": {
      "type": "object",
      "required": ["cli", "version"],
      "additionalProperties": false,
      "properties": {
        "cli": { "type": "string" },
        "version": { "type": "string" }
      }
    },
    "context": {
      "type": "object",
      "required": ["run_id", "mode", "compose_sha256"],
      "additionalProperties": false,
      "properties": {
        "run_id": { "type": "string" },
        "mode": { "type": "string", "enum": ["conceptual", "shipping", "compose"] },
        "compose_sha256": { "type": "string", "pattern": "^[0-9a-f]{64}$" }
      }
    },
    "detail": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "module": { "type": "string" },
        "port": { "type": "string" },
        "test": { "type": "string" },
        "dur_ms": { "type": "number", "minimum": 0 },
        "error": { "type": "string" },
        "code": { "type": "string", "pattern": "^[A-Z0-9_]+$" },
        "gain": { "type": "number" },
        "profile": { "type": "string" },
        "drivers": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "coverage_contribution": { "type": "number" },
            "coverage_goals": { "type": "array", "items": { "type": "string" } },
            "evidence_strength": { "type": "number" },
            "risk": { "type": "number" },
            "delta_cost": { "type": "number" },
            "hygiene": { "type": "number" },
            "bundle": { "type": "array", "items": { "type": "string" } }
          }
        },
        "artifact": { "type": "string" },
        "compose_path": { "type": "string" },
        "modules_total": { "type": "integer", "minimum": 0 },
        "message": { "type": "string" },
        "lint_tool": { "type": "string" },
        "file": { "type": "string" },
        "line": { "type": "integer", "minimum": 0 },
        "spec": { "type": "string" },
        "case": { "type": "string" },
        "attempts": { "type": "integer", "minimum": 1 },
        "passed": { "type": "integer", "minimum": 0 },
        "failed": { "type": "integer", "minimum": 0 },
        "side_effects": { "$ref": "#/$defs/side_effect_summary" },
        "added": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "modules": { "type": "array", "items": { "type": "string" } },
            "wiring": { "type": "array", "items": { "type": "string" } },
            "constraints": { "type": "array", "items": { "type": "string" } }
          }
        },
        "replaced": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "modules": { "type": "array", "items": { "type": "string" } },
            "wiring": { "type": "array", "items": { "type": "string" } }
          }
        },
        "removed": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "modules": { "type": "array", "items": { "type": "string" } },
            "wiring": { "type": "array", "items": { "type": "string" } }
          }
        },
        "removed_constraints": { "type": "array", "items": { "type": "string" } },
        "sections": { "type": "array", "items": { "type": "string" } },
        "overrides_path": { "type": "string" }
      }
    }
  }
}
